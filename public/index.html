<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Web App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="library-header text-white text-center p-4 mb-4 rounded">
                    <h1 class="display-4">üìö Library Web App</h1>
                    <p class="lead">Browse our collection of books</p>
                </div>

                <!-- Stats Card -->
                <div class="card stats-card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">üìä Collection Stats</h5>
                        <p class="card-text">Total Books: <span id="book-count" class="badge bg-primary stats-badge">Loading...</span></p>
                    </div>
                </div>

                <!-- Add New Book Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">‚ûï Add New Book</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-book-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="book-title" class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="book-title" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="book-author" class="form-label">Author *</label>
                                    <input type="text" class="form-control" id="book-author" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="book-isbn" class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="book-isbn" placeholder="10-13 digits" pattern="[\d\-\s]{10,17}">
                                    <div class="form-text">10-13 digits, hyphens/spaces allowed</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="book-genre" class="form-label">Genre</label>
                                    <input type="text" class="form-control" id="book-genre" maxlength="32" placeholder="e.g., Fiction, Science">
                                    <div class="form-text">Max: 32 characters</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="book-year" class="form-label">Publication Year</label>
                                    <input type="number" class="form-control" id="book-year" min="-3000" max="2025">
                                    <div class="form-text">Max year: 2025</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="book-description" class="form-label">Description</label>
                                <textarea class="form-control" id="book-description" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Book</button>
                        </form>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                <div id="form-success" class="alert alert-success d-none" role="alert"></div>
                <div id="form-error" class="alert alert-danger d-none" role="alert"></div>

                <!-- Loading and Error Messages -->
                <div id="loading" class="text-center loading-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 loading-text">Loading books...</p>
                </div>
                <div id="error" class="alert alert-danger error-alert d-none" role="alert"></div>

                <!-- Books Table -->
                <div class="card books-table-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìñ Books Collection</h5>
                        <input type="text" class="form-control" id="search-books" placeholder="Search books..." style="max-width: 250px;">
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover books-table" id="books-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(1)">Title <span id="title-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(2)">Author <span id="author-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col">ISBN</th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(4)">Genre <span id="genre-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(5)">Year <span id="year-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="books-tbody">
                                    <!-- Books will be populated here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBookModalLabel">‚úèÔ∏è Edit Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-book-form">
                        <input type="hidden" id="edit-book-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-book-title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="edit-book-title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-book-author" class="form-label">Author *</label>
                                <input type="text" class="form-control" id="edit-book-author" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit-book-isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="edit-book-isbn" placeholder="10-13 digits" pattern="[\d\-\s]{10,17}">
                                <div class="form-text">Optional: 10-13 digits</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-book-genre" class="form-label">Genre</label>
                                <input type="text" class="form-control" id="edit-book-genre" placeholder="e.g., Fiction, Science" maxlength="32">
                                <div class="form-text">Max: 32 characters</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-book-year" class="form-label">Publication Year</label>
                                <input type="number" class="form-control" id="edit-book-year" min="-3000" max="2025" placeholder="e.g., 2023">
                                <div class="form-text">Max: 2025</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-book-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-book-description" rows="3" placeholder="Brief description of the book..."></textarea>
                        </div>
                        
                        <!-- Success/Error Messages -->
                        <div id="edit-form-success" class="alert alert-success d-none" role="alert"></div>
                        <div id="edit-form-error" class="alert alert-danger d-none" role="alert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateBook()">üíæ Update Book</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadBooks() {
            try {
                const response = await fetch('/api/books');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const books = await response.json();
                
                // Hide loading indicator
                document.getElementById('loading').classList.add('d-none');
                
                // Update stats with animation
                const bookCountElement = document.getElementById('book-count');
                bookCountElement.textContent = books.length;
                bookCountElement.classList.add('count-animate');
                setTimeout(() => bookCountElement.classList.remove('count-animate'), 300);
                
                // Render books in table
                renderBooks(books);
                
            } catch (error) {
                console.error('Error loading books:', error);
                document.getElementById('loading').classList.add('d-none');
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error loading books: ${error.message}`;
                errorDiv.classList.remove('d-none');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function renderBooks(books) {
            const tbody = document.getElementById('books-tbody');
            tbody.innerHTML = '';
            
            if (books.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center empty-state">
                            <div class="empty-state-icon">üìö</div>
                            <em>No books found in the library.</em>
                        </td>
                    </tr>
                `;
                return;
            }
            
            books.forEach((book, index) => {
                const row = document.createElement('tr');
                row.className = 'book-row';
                row.innerHTML = `
                    <td><span class="book-id">${book.id}</span></td>
                    <td class="book-title">${escapeHtml(book.title)}</td>
                    <td class="book-author">${escapeHtml(book.author)}</td>
                    <td class="book-isbn">${book.isbn || 'N/A'}</td>
                    <td class="book-genre">${escapeHtml(book.genre || 'N/A')}</td>
                    <td class="book-year">${book.publication_year || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-2" onclick="editBook('${book.id}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteBook('${book.id}', '${escapeHtml(book.title)}')">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Simple table sorting
        let sortDirection = { 1: 1, 2: 1, 4: 1, 5: 1 }; // 1 = ascending, -1 = descending
        
        function sortTable(columnIndex) {
            const table = document.getElementById('books-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            sortDirection[columnIndex] *= -1;
            
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex]?.textContent.toLowerCase() || '';
                const bText = b.cells[columnIndex]?.textContent.toLowerCase() || '';
                return aText.localeCompare(bText) * sortDirection[columnIndex];
            });
            
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort indicators
            document.getElementById('title-sort').textContent = columnIndex === 1 ? (sortDirection[1] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('author-sort').textContent = columnIndex === 2 ? (sortDirection[2] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('genre-sort').textContent = columnIndex === 4 ? (sortDirection[4] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('year-sort').textContent = columnIndex === 5 ? (sortDirection[5] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
        }
        
        // Add new book functionality
        async function addBook(bookData) {
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add book');
                }

                const newBook = await response.json();
                
                // Show success message
                const successDiv = document.getElementById('form-success');
                successDiv.textContent = `Successfully added "${newBook.title}" to the library!`;
                successDiv.classList.remove('d-none');
                
                // Hide error message
                document.getElementById('form-error').classList.add('d-none');
                
                // Reset form
                document.getElementById('add-book-form').reset();
                
                // Reload books to show the new one
                loadBooks();
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    successDiv.classList.add('d-none');
                }, 5000);
                
            } catch (error) {
                console.error('Error adding book:', error);
                
                // Show error message
                const errorDiv = document.getElementById('form-error');
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
                
                // Hide success message
                document.getElementById('form-success').classList.add('d-none');
            }
        }

        // Server-side search functionality with debouncing
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search-books').addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // Debounce search - wait 300ms after user stops typing
                searchTimeout = setTimeout(async () => {
                    try {
                        const url = searchTerm 
                            ? `/api/books/search?q=${encodeURIComponent(searchTerm)}`
                            : '/api/books';
                            
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const books = await response.json();
                        
                        // Update book count
                        document.getElementById('book-count').textContent = books.length;
                        
                        // Re-render table with search results
                        renderBooks(books);
                        
                    } catch (error) {
                        console.error('Error searching books:', error);
                    }
                }, 300);
            });
        });

        // Handle add book form submission
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-book-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const title = document.getElementById('book-title').value.trim();
                const author = document.getElementById('book-author').value.trim();
                const isbn = document.getElementById('book-isbn').value.trim();
                const year = document.getElementById('book-year').value;
                
                // Client-side validation
                if (!title || !author) {
                    document.getElementById('form-error').textContent = 'Title and Author are required';
                    document.getElementById('form-error').classList.remove('d-none');
                    return;
                }
                
                if (isbn) {
                    const cleanISBN = isbn.replace(/[-\s]/g, '');
                    if (!/^\d{10,13}$/.test(cleanISBN)) {
                        document.getElementById('form-error').textContent = 'ISBN must be 10-13 digits only';
                        document.getElementById('form-error').classList.remove('d-none');
                        return;
                    }
                }
                
                if (year && parseInt(year) > 2025) {
                    document.getElementById('form-error').textContent = 'Publication year cannot be beyond 2025';
                    document.getElementById('form-error').classList.remove('d-none');
                    return;
                }
                
                const genre = document.getElementById('book-genre').value.trim();
                if (genre && genre.length > 32) {
                    document.getElementById('form-error').textContent = 'Genre cannot exceed 32 characters';
                    document.getElementById('form-error').classList.remove('d-none');
                    return;
                }
                
                const formData = {
                    title: title,
                    author: author,
                    isbn: isbn || undefined,
                    genre: genre || undefined,
                    publication_year: year ? parseInt(year) : undefined,
                    description: document.getElementById('book-description').value.trim() || undefined
                };
                
                addBook(formData);
            });
        });

        // Delete book functionality
        async function deleteBook(bookId, bookTitle) {
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete "${bookTitle}"?\n\nThis action cannot be undone.`);
            
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/books/${bookId}`, {
                    method: 'DELETE'
                });

                if (response.status === 204) {
                    // Success - reload books to show updated list
                    loadBooks();
                    
                    // Show success message (you can enhance this with a better notification system)
                    alert(`"${bookTitle}" has been successfully deleted from the library.`);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete book');
                }
                
            } catch (error) {
                console.error('Error deleting book:', error);
                alert(`Error deleting book: ${error.message}`);
            }
        }

        // Edit book functionality
        async function editBook(bookId) {
            try {
                // Fetch current book data
                const response = await fetch(`/api/books/${bookId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch book data');
                }
                const book = await response.json();
                
                // Populate the edit form
                document.getElementById('edit-book-id').value = book.id;
                document.getElementById('edit-book-title').value = book.title;
                document.getElementById('edit-book-author').value = book.author;
                document.getElementById('edit-book-isbn').value = book.isbn || '';
                document.getElementById('edit-book-genre').value = book.genre || '';
                document.getElementById('edit-book-year').value = book.publication_year || '';
                document.getElementById('edit-book-description').value = book.description || '';
                
                // Clear any previous messages
                document.getElementById('edit-form-success').classList.add('d-none');
                document.getElementById('edit-form-error').classList.add('d-none');
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editBookModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error fetching book for edit:', error);
                alert(`Error loading book data: ${error.message}`);
            }
        }

        async function updateBook() {
            try {
                const bookId = document.getElementById('edit-book-id').value;
                const title = document.getElementById('edit-book-title').value.trim();
                const author = document.getElementById('edit-book-author').value.trim();
                const isbn = document.getElementById('edit-book-isbn').value.trim();
                const year = document.getElementById('edit-book-year').value;
                
                // Client-side validation
                if (!title || !author) {
                    document.getElementById('edit-form-error').textContent = 'Title and Author are required';
                    document.getElementById('edit-form-error').classList.remove('d-none');
                    return;
                }
                
                if (isbn) {
                    const cleanISBN = isbn.replace(/[-\s]/g, '');
                    if (!/^\d{10,13}$/.test(cleanISBN)) {
                        document.getElementById('edit-form-error').textContent = 'ISBN must be 10-13 digits only';
                        document.getElementById('edit-form-error').classList.remove('d-none');
                        return;
                    }
                }
                
                if (year && parseInt(year) > 2025) {
                    document.getElementById('edit-form-error').textContent = 'Publication year cannot be beyond 2025';
                    document.getElementById('edit-form-error').classList.remove('d-none');
                    return;
                }
                
                const genre = document.getElementById('edit-book-genre').value.trim();
                if (genre && genre.length > 32) {
                    document.getElementById('edit-form-error').textContent = 'Genre cannot exceed 32 characters';
                    document.getElementById('edit-form-error').classList.remove('d-none');
                    return;
                }
                
                const formData = {
                    title: title,
                    author: author,
                    isbn: isbn || undefined,
                    genre: genre || undefined,
                    publication_year: year ? parseInt(year) : undefined,
                    description: document.getElementById('edit-book-description').value.trim() || undefined
                };
                
                const response = await fetch(`/api/books/${bookId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update book');
                }

                const updatedBook = await response.json();
                
                // Show success message
                const successDiv = document.getElementById('edit-form-success');
                successDiv.textContent = `Successfully updated "${updatedBook.title}"!`;
                successDiv.classList.remove('d-none');
                
                // Hide error message
                document.getElementById('edit-form-error').classList.add('d-none');
                
                // Reload books to show the updated book
                loadBooks();
                
                // Hide modal after a short delay
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editBookModal'));
                    modal.hide();
                }, 1500);
                
            } catch (error) {
                console.error('Error updating book:', error);
                
                // Show error message
                const errorDiv = document.getElementById('edit-form-error');
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
                
                // Hide success message
                document.getElementById('edit-form-success').classList.add('d-none');
            }
        }

        // Load books when page loads
        document.addEventListener('DOMContentLoaded', loadBooks);
        
        // Refresh every 30 seconds
        setInterval(loadBooks, 30000);
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>