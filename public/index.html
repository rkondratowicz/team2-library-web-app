<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Web App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="library-header text-white text-center p-4 mb-4 rounded">
                    <h1 class="display-4">üìö Library Web App</h1>
                    <p class="lead">Browse our collection of books</p>
                </div>

                <!-- Stats Card -->
                <div class="card stats-card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">üìä Collection Stats</h5>
                        <p class="card-text">Total Books: <span id="book-count" class="badge bg-primary stats-badge">Loading...</span></p>
                    </div>
                </div>

                <!-- Loading and Error Messages -->
                <div id="loading" class="text-center loading-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 loading-text">Loading books...</p>
                </div>
                <div id="error" class="alert alert-danger error-alert d-none" role="alert"></div>

                <!-- Books Table -->
                <div class="card books-table-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìñ Books Collection</h5>
                        <input type="text" class="form-control" id="search-books" placeholder="Search books..." style="max-width: 250px;">
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover books-table" id="books-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(1)">Title <span id="title-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(2)">Author <span id="author-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col">ISBN</th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(4)">Genre <span id="genre-sort">‚ÜïÔ∏è</span></th>
                                        <th scope="col" style="cursor: pointer;" onclick="sortTable(5)">Year <span id="year-sort">‚ÜïÔ∏è</span></th>
                                    </tr>
                                </thead>
                                <tbody id="books-tbody">
                                    <!-- Books will be populated here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadBooks() {
            try {
                const response = await fetch('/api/books');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const books = await response.json();
                
                // Hide loading indicator
                document.getElementById('loading').classList.add('d-none');
                
                // Update stats with animation
                const bookCountElement = document.getElementById('book-count');
                bookCountElement.textContent = books.length;
                bookCountElement.classList.add('count-animate');
                setTimeout(() => bookCountElement.classList.remove('count-animate'), 300);
                
                // Render books in table
                renderBooks(books);
                
            } catch (error) {
                console.error('Error loading books:', error);
                document.getElementById('loading').classList.add('d-none');
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error loading books: ${error.message}`;
                errorDiv.classList.remove('d-none');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function renderBooks(books) {
            const tbody = document.getElementById('books-tbody');
            tbody.innerHTML = '';
            
            if (books.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center empty-state">
                            <div class="empty-state-icon">üìö</div>
                            <em>No books found in the library.</em>
                        </td>
                    </tr>
                `;
                return;
            }
            
            books.forEach((book, index) => {
                const row = document.createElement('tr');
                row.className = 'book-row';
                row.innerHTML = `
                    <td><span class="book-id">${book.id}</span></td>
                    <td class="book-title">${escapeHtml(book.title)}</td>
                    <td class="book-author">${escapeHtml(book.author)}</td>
                    <td class="book-isbn">${book.isbn || 'N/A'}</td>
                    <td class="book-genre">${escapeHtml(book.genre || 'N/A')}</td>
                    <td class="book-year">${book.publication_year || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Simple table sorting
        let sortDirection = { 1: 1, 2: 1, 4: 1, 5: 1 }; // 1 = ascending, -1 = descending
        
        function sortTable(columnIndex) {
            const table = document.getElementById('books-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            sortDirection[columnIndex] *= -1;
            
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex]?.textContent.toLowerCase() || '';
                const bText = b.cells[columnIndex]?.textContent.toLowerCase() || '';
                return aText.localeCompare(bText) * sortDirection[columnIndex];
            });
            
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort indicators
            document.getElementById('title-sort').textContent = columnIndex === 1 ? (sortDirection[1] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('author-sort').textContent = columnIndex === 2 ? (sortDirection[2] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('genre-sort').textContent = columnIndex === 4 ? (sortDirection[4] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
            document.getElementById('year-sort').textContent = columnIndex === 5 ? (sortDirection[5] === 1 ? '‚Üë' : '‚Üì') : '‚ÜïÔ∏è';
        }
        
        // Server-side search functionality with debouncing
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search-books').addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // Debounce search - wait 300ms after user stops typing
                searchTimeout = setTimeout(async () => {
                    try {
                        const url = searchTerm 
                            ? `/api/books/search?q=${encodeURIComponent(searchTerm)}`
                            : '/api/books';
                            
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const books = await response.json();
                        
                        // Update book count
                        document.getElementById('book-count').textContent = books.length;
                        
                        // Re-render table with search results
                        renderBooks(books);
                        
                    } catch (error) {
                        console.error('Error searching books:', error);
                    }
                }, 300);
            });
        });

        // Load books when page loads
        document.addEventListener('DOMContentLoaded', loadBooks);
        
        // Refresh every 30 seconds
        setInterval(loadBooks, 30000);
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>